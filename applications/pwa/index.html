<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta charset="UTF-8">
	<title>Progressive Web App - roBrowserLegacy</title>
	<link rel="icon" type="./icon.png">

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="HandheldFriendly" content="true">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="roBrowser">
	<meta name="mobile-web-app-capable" content="yes">

	<meta name="description" content="roBrowser">
	<meta name="keywords" content="roBrowser">
	<meta name="author" content="roBrowser">
	<meta name="robots" content="index">

	<meta name="theme-color" content="#ff8cb5">

	<meta property="og:title" content="roBrowser">
	<meta property="og:description" content="roBrowser">
	<meta property="og:type" content="website">
	<meta property="og:locale" content="en_US">
	<meta property="og:image" content="./screenshotwide.png">
	<meta property="og:image:width" content="1920">
	<meta property="og:image:height" content="1080">
	<meta property="og:image:type" content="image/png">
	<meta property="og:image:alt" content="roBrowser Progressive Web App">

	<link rel="apple-touch-icon" href="./icon.png">
	<link rel="manifest" href="./manifest.webmanifest">

	<style type="text/css">
		html,
		div,
		body {
			margin: 0;
			padding: 0;
			border: 0;
			height: 100%;
			width: 100%;
			overflow: hidden;
		}
	</style>

	<script type="text/javascript" src="../api/api.js"></script>
	<script type="text/javascript" src="Config.js"></script>
	<script type="text/javascript">
		// Load optional Config.local.js for overrides (fails silently if not present)
		(function() {
			var script = document.createElement('script');
			script.src = 'Config.local.js';
			script.onerror = function() {
				console.log('Config.local.js not found, using defaults from Config.js');
			};
			document.head.appendChild(script);
		})();
	</script>
	<script type="text/javascript">

		function deepMerge(target, source) {
			for (var key in source) {
				if (source.hasOwnProperty(key)) {
					if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
						target[key] = deepMerge(target[key] || {}, source[key]);
					} else {
						target[key] = source[key];
					}
				}
			}
			return target;
		}

		function initialize(gitHash) {
			// Merge Config.js defaults with Config.local.js overrides
			var baseConfig = deepMerge({}, window.ROConfigBase || {});
			if (window.ROConfigLocal) {
				baseConfig = deepMerge(baseConfig, window.ROConfigLocal);
			}

			// Build ROConfig with dynamic values
			var ROConfig = Object.assign({}, baseConfig, {
				target: document.getElementById("robrowser"),
				type: ROBrowser.TYPE[baseConfig.type || 'FRAME'],
				application: ROBrowser.APP[baseConfig.application || 'ONLINE'],
				version: gitHash
			});
			var RO = new ROBrowser(ROConfig);
			RO.start();
		}

		var getJSON = function (url, callback) {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', url, true);
			xhr.responseType = 'json';
			xhr.onload = function () {
				var status = xhr.status;
				if (status === 200) {
					callback(null, xhr.response);
				} else {
					callback(status, xhr.response);
				}
			};
			xhr.send();
		};

		window.addEventListener("load", function () {
			//Get latest GIT hash first then initialize
			getJSON('https://api.github.com/repos/MrAntares/roBrowserLegacy/commits/master',
				function (err, data) {
					var gitHash = 'NO_INFO';
					if (err !== null) {
						console.warn("Error reading latest GIT hash.");
					} else {
						if (data && data.sha) {
							gitHash = data.sha;
							console.log("Latest GIT hash: " + gitHash);
						} else {
							console.warn('No hash found in response');
						}
					}
					initialize(gitHash);
				});
		}, false);
	</script>

</head>

<body>
	<div id="robrowser">Initializing roBrowser...</div>
</body>

</html>